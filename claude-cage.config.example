claude_cage {

    -- Project name (optional - derived from directory structure if not specified)
    -- The script searches for claude-cage.config up the directory tree.
    -- Project name is derived from the first directory component after the config root.
    -- Example: config at ~/Projects/claude-cage.config, running from ~/Projects/myapp/src
    --          -> project = "myapp" (derived automatically)
    --
    -- You can override this by specifying it here or on command line.
    -- Command line takes precedence: sudo claude-cage backend
    -- project = "myproject",

    -- Project-specific config files (optional)
    -- Create projectname.claude-cage.config for project-specific overrides
    -- Example: backend.claude-cage.config, frontend.claude-cage.config
    -- These are loaded when you run from that project's subdirectory

    -- Base user name (default: "claude")
    -- Used in user isolation mode
    -- user = "claude",

    -- ============================================================================
    -- ISOLATION MODE: Choose between user isolation or Docker isolation
    -- ============================================================================

    -- Isolation mode (default: "user")
    -- Options: "user" or "docker"
    --
    -- User mode (default): Uses a separate Unix user for isolation
    --   - Requires sudo to run (creates/uses system user)
    --   - Uses bindfs for permission mapping
    --   - Uses iptables/pf for network restrictions
    --   - Claude Code login persists in user's home directory
    --
    -- Docker mode: Uses a Docker container for isolation
    --   - No sudo required (just Docker group membership)
    --   - Uses Docker volumes for file access
    --   - Uses Docker networking (--network=none or bridge)
    --   - Claude Code login persists in container between runs
    --
    -- isolationMode = "user",

    -- ============================================================================
    -- DOCKER MODE SETTINGS (only used when isolationMode = "docker")
    -- ============================================================================

    -- docker = {
    --     -- Base Docker image (must have Node.js for Claude Code)
    --     image = "node:lts-slim",
    --
    --     -- Additional packages to install (uses apt-get)
    --     packages = { "git", "curl" },
    --
    --     -- Container name prefix (full name: prefix-uid for shared, prefix-project-hash for isolated)
    --     namePrefix = "claude-cage",
    --
    --     -- Extra arguments for docker run command
    --     extraArgs = "",
    --
    --     -- Container isolation (default: false = shared container for all projects)
    --     -- Set to true for per-project containers (different packages/versions per project)
    --     isolated = false,
    --
    --     -- Note: Container names include host UID (e.g., "claude-cage-1000") to avoid
    --     -- collisions when multiple users on the same system use claude-cage.
    --
    --     -- Use an existing container (user-managed, see docs/docker-existing-container.md)
    --     -- When set, claude-cage will exec into this container instead of creating one
    --     -- container = "my-dev-container",
    --     -- user = "node",              -- User to run as in existing container
    --     -- workdir = "/app",           -- Working directory in existing container
    --     -- homeMount = "/workspace/.persist",  -- Custom mount location for persistent home (existing containers only)
    -- },
    --
    -- Persistent home directory:
    -- - Managed containers: Home directory is mounted from ~/.local/share/claude-cage/docker/{container}/docker-home/
    --   (or .caged/{project}/home/ for isolated mode). Credentials persist between runs.
    -- - Existing containers: Can't mount directly as home (would overwrite content).
    --   Uses symlinks from actual home to mounted persistent directory.
    --
    -- Containers are stopped on exit but kept for --continue/--resume.
    -- To delete a container: claude-cage --delete-docker-container

    -- ============================================================================
    -- MODE SELECTION: Choose sync mode (default) or direct mount mode
    -- ============================================================================

    -- Direct mount mode (default: false)
    -- false: Sync mode - creates sync directory with unison, provides file exclusion
    -- "workspace": Direct mount - mounts entire source, Claude can access sibling projects
    -- "project": Direct mount - mounts only the specified project, no sibling access
    --
    -- In both direct mount modes:
    --   - Command-line argument specifies which project to work in (required)
    --   - No file exclusion - all files in mounted directory are accessible
    --   - Only use with directories containing files safe for Claude to access
    --
    -- Workspace mode: Mount point name derived from source directory basename
    --   Example: cd ~/Projects/public && sudo claude-cage my-project
    --   Mounts ~/Projects/public/ to /run/claude-cage/mounts/projects/public/
    --   Claude starts in .../public/my-project/ but can cd to siblings
    --
    -- Project mode: Mount point name is the project subdirectory name
    --   Example: cd ~/Projects/public && sudo claude-cage my-project
    --   Mounts ~/Projects/public/my-project/ to /run/claude-cage/mounts/projects/my-project/
    --   Claude starts at mount root, cannot access sibling projects
    --
    -- directMount = false,

    -- ============================================================================
    -- SYNC MODE SETTINGS (ignored in direct mount mode)
    -- ============================================================================

    -- Source directory (optional - defaults to config root directory)
    -- The script uses the directory containing claude-cage.config as the source.
    -- You can override this to sync only a subdirectory.
    --
    -- IMPORTANT: In sync mode, you cannot run from the config root directory.
    -- You must cd into a subdirectory first to avoid .caged recursion issues.
    -- source = "my-directory",

    -- Sync directory for unison to sync source with (sync mode only)
    -- Default: .caged/project-name/sync
    -- Structure: .caged/project-name/sync and .caged/project-name/excludes-cache
    -- Add ".caged" to .gitignore if running from within a git repository
    -- sync = ".caged/myproject/sync",

    -- mounted: Final directory name in the mount path (default: project name)
    --   Mount points are in /run/claude-cage/mounts/projects/<mounted>/
    --   This is the actual working directory where Claude starts
    --   Example: mounted = "my-app" → /run/claude-cage/mounts/projects/my-app/
    -- mounted = "",  -- Defaults to project name

    -- Show ASCII art banner (default: true)
    -- Set to false to disable banner, or use --no-banner CLI flag
    -- showBanner = false,

    -- ============================================================================
    -- FILE EXCLUSION (SYNC MODE ONLY - ignored in direct mount mode)
    -- ============================================================================

    -- PROJECT-SPECIFIC excludes (add to user/system defaults)
    -- These are merged with excludes from system and user configs
    -- All exclude options are grouped under the 'exclude' object:
    --
    -- exclude = {
    --     path = { "config/production.yml" },  -- exact paths relative to source root
    --     name = { ".env", "node_modules" },   -- files/folders by name anywhere in tree
    --     belowPath = { ".git" },              -- path + everything below it (root only)
    --     regex = { ".*\\.log$" }              -- regex patterns for complex matching
    -- },
    --
    -- path: Exact paths from source root
    -- name: Matches anywhere in tree (use for .env, node_modules, target, etc.)
    -- belowPath: Root path + all contents (use for .git)
    -- regex: Complex patterns (escape backslashes in Lua strings)

    -- ============================================================================
    -- CAGE-LOCAL FILES (SYNC MODE ONLY - ignored in direct mount mode)
    -- ============================================================================

    -- Prevents new files created in cage from appearing in source.
    --
    -- Unlike 'exclude' (which never syncs in either direction), cageLocal only
    -- blocks creation of NEW files on the source side:
    --   - New files created in cage → don't appear in source
    --   - Existing files in both → sync normally (updates go both ways)
    --
    -- Example: shell/tool config files Claude creates (.bashrc, .gitconfig, etc.)
    --
    -- cageLocal = {
    --     name = { ".bashrc", ".profile", ".zshrc", ".gitconfig", ".mcp.json" }
    -- },

    -- ============================================================================
    -- HOME CONFIG SYNC (optional - sync config files to cage user's home)
    -- ============================================================================

    -- Sync config files or directories from your home directory to the cage
    -- user's persistent home. Paths are relative to home directory.
    --
    -- Entries are processed in order - useful for copying a directory first,
    -- then overwriting specific files within it.
    --
    -- WARNING: Be careful not to sync files containing secrets (API keys,
    -- tokens, credentials). Review each file before adding it here.
    --
    -- MODES:
    --   init (default): Copy only if destination doesn't exist. Good for bootstrap.
    --   copy: Copy on startup, overwrites existing each run.
    --   sync: Bidirectional sync via background unison process. Changes go both ways.
    --   link: Symlink from cage home to host path. Best for directories (files may break).
    --
    -- SYNTAX:
    --   Simple string → init mode, same source/destination path
    --   Table with options → full control over mode, destination, excludes

    -- Ready-to-use example: sync Claude credentials and binary
    homeConfigSync = {
        ".gitconfig",
        { path = ".claude", mode = "sync" },
        { path = ".claude.json", mode = "sync" },
        ".local/bin/claude",  -- init mode: copy once (see note below)
    },

    -- More examples (commented out):
    -- homeConfigSync = {
    --     -- Simple strings: init mode (backward compatible)
    --     ".gitconfig",                                                    -- same path, mode=init
    --     ".npmrc",                                                        -- same path, mode=init
    --
    --     -- New table syntax with modes
    --     { path = ".claude", mode = "sync",                               -- bidirectional sync
    --       exclude = { path = { "settings.json" }, belowPath = { "logs" } } },
    --     { path = ".claude.json", mode = "sync" },                        -- bidirectional sync
    --     { path = ".config/claude-cage/claude-settings.json",             -- different destination
    --       destination = ".claude/settings.json" },                       -- mode=init (default)
    --     { path = ".bashrc", mode = "copy" },                             -- overwrite each run
    --     { path = ".ssh", mode = "link" },                                -- symlink (directories OK)
    -- },
    --
    -- Note: For sync mode, only exclude.path and exclude.belowPath are supported
    -- (not exclude.name or exclude.regex since they can't be scoped to a specific path).
    --
    -- Note: .local/bin/claude should use init mode (not sync). Claude Code installs as
    -- a symlink to a versioned directory. If synced, cage updates could copy back a
    -- broken symlink pointing to a version that only exists in the cage.

    -- ============================================================================
    -- NETWORK RESTRICTIONS (optional - defense in depth)
    -- ============================================================================

    -- Network mode (default: "disabled")
    -- Options: "disabled", "allowlist", "blocklist"
    -- networkMode = "disabled",

    -- NOTE: In user mode, network rules are shared across all projects and
    -- persist until the last instance exits.
    --
    -- In Docker mode, network restrictions are simpler:
    --   - disabled/allowlist: --network=none (no network access)
    --   - blocklist: --network=bridge (full network access)
    -- Docker doesn't support granular destination filtering without host iptables.

    -- Allowlist mode: Only allow specific connections (everything else blocked)
    -- allow = {
    --     domains = { "github.com:443", "registry.npmjs.org:443" },
    --     ips = { "127.0.0.1:5432" },
    --     networks = { "192.168.1.0/24" }
    -- },

    -- Blocklist mode: Block specific connections (everything else allowed)
    -- block = {
    --     domains = { "internal.company.com" },
    --     ips = { "169.254.169.254" },
    --     networks = { "127.0.0.1", "192.168.0.0/16", "10.0.0.0/8" }
    -- },

    -- Blocklist exceptions: Allow specific connections even when blocked
    -- (Can use allow.domains/ips/networks in blocklist mode for exceptions)
    -- allow = { ips = { "127.0.0.1:5432" } },  -- Allow PostgreSQL even if localhost blocked
}
